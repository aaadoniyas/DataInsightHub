{% extends "layout.html" %}

{% block content %}
<div class="row">
    <!-- Gender Selection Controls -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header bg-info bg-opacity-10">
                <h3><i class="fas fa-filter me-2"></i>Filter Data by Gender</h3>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="btn-group" role="group" aria-label="Gender selection">
                            <a href="/?gender=both" class="btn btn-outline-primary {% if selected_gender == 'both' %}active{% endif %}">Combined Data</a>
                            <a href="/?gender=male" class="btn btn-outline-primary {% if selected_gender == 'male' %}active{% endif %}">Male Data</a>
                            <a href="/?gender=female" class="btn btn-outline-primary {% if selected_gender == 'female' %}active{% endif %}">Female Data</a>
                        </div>
                    </div>
                    <div class="col-md-6 text-md-end mt-3 mt-md-0">
                        <a href="/download?gender={{ selected_gender }}" class="btn btn-outline-success">
                            <i class="fas fa-file-excel me-2"></i>Download {{ selected_gender.capitalize() }} Data Report
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary panel -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header bg-primary bg-opacity-10">
                <h2><i class="fas fa-info-circle me-2"></i>Dataset Overview</h2>
                <p class="mb-0">
                    {% if selected_gender == 'both' %}
                        Ethiopian army personnel anthropometric measurements across 40 dimensions on head and face examining both males and females.
                        The data represents 100 male and 56 female subjects with measurements in millimeters.
                    {% elif selected_gender == 'male' %}
                        Ethiopian army male personnel anthropometric measurements across 40 dimensions on head and face.
                        The data represents 100 male subjects with measurements in millimeters.
                    {% else %}
                        Ethiopian army female personnel anthropometric measurements across 40 dimensions on head and face.
                        The data represents 56 female subjects with measurements in millimeters.
                    {% endif %}
                </p>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h4 class="border-bottom pb-2">Measurement Categories</h4>
                        <div class="measurement-group">
                            <h5>
                                <button class="btn btn-link p-0 toggle-measurements" data-target="head-measurements">
                                    <i class="fas fa-chevron-down me-1"></i>
                                    Head Measurements
                                </button>
                            </h5>
                            <div class="collapse" id="head-measurements">
                                <ul>
                                    <li>Total head height</li>
                                    <li>Head circumference</li>
                                    <li>Head length</li>
                                    <li>Head breadth</li>
                                    <li>Frontotemporale breadth</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="measurement-group">
                            <h5>
                                <button class="btn btn-link p-0 toggle-measurements" data-target="face-measurements">
                                    <i class="fas fa-chevron-down me-1"></i>
                                    Face Measurements
                                </button>
                            </h5>
                            <div class="collapse" id="face-measurements">
                                <ul>
                                    <li>Face length</li>
                                    <li>Bizygomatic breadth</li>
                                    <li>Morphologic face height</li>
                                    <li>Physiognomic face height</li>
                                    <li>Bigonial breadth</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="measurement-group">
                            <h5>
                                <button class="btn btn-link p-0 toggle-measurements" data-target="eye-measurements">
                                    <i class="fas fa-chevron-down me-1"></i>
                                    Eye Region Measurements
                                </button>
                            </h5>
                            <div class="collapse" id="eye-measurements">
                                <ul>
                                    <li>Biocular breadth</li>
                                    <li>Interpupillary distance</li>
                                    <li>Interocular breadth</li>
                                    <li>Right/Left ectocanthion to vertex height</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="measurement-group">
                            <h5>
                                <button class="btn btn-link p-0 toggle-measurements" data-target="nose-measurements">
                                    <i class="fas fa-chevron-down me-1"></i>
                                    Nose Measurements
                                </button>
                            </h5>
                            <div class="collapse" id="nose-measurements">
                                <ul>
                                    <li>Nose length</li>
                                    <li>Nose breadth</li>
                                    <li>Nasal root breadth</li>
                                    <li>Pronasale to vertex height</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="measurement-group">
                            <h5>
                                <button class="btn btn-link p-0 toggle-measurements" data-target="ear-measurements">
                                    <i class="fas fa-chevron-down me-1"></i>
                                    Ear Measurements
                                </button>
                            </h5>
                            <div class="collapse" id="ear-measurements">
                                <ul>
                                    <li>Ear length</li>
                                    <li>Right tragion to ectocanthion length</li>
                                    <li>Right/Left tragion to vertex height</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="measurement-group">
                            <h5>
                                <button class="btn btn-link p-0 toggle-measurements" data-target="other-measurements">
                                    <i class="fas fa-chevron-down me-1"></i>
                                    Other Measurements
                                </button>
                            </h5>
                            <div class="collapse" id="other-measurements">
                                <ul>
                                    <li>Sagittal arc</li>
                                    <li>Bitragion arc</li>
                                    <li>Mouth breadth</li>
                                    <li>Occiput to stomion distance</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tab navigation -->
<ul class="nav nav-tabs mb-4" id="analysis-tabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="statistics-tab" data-bs-toggle="tab" data-bs-target="#statistics" 
                type="button" role="tab" aria-controls="statistics" aria-selected="true">
            <i class="fas fa-calculator me-2"></i>Statistics
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="pca-tab" data-bs-toggle="tab" data-bs-target="#pca" 
                type="button" role="tab" aria-controls="pca" aria-selected="false">
            <i class="fas fa-project-diagram me-2"></i>PCA
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="visualizations-tab" data-bs-toggle="tab" data-bs-target="#visualizations" 
                type="button" role="tab" aria-controls="visualizations" aria-selected="false">
            <i class="fas fa-chart-bar me-2"></i>Visualizations
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="results-tab" data-bs-toggle="tab" data-bs-target="#results" 
                type="button" role="tab" aria-controls="results" aria-selected="false">
            <i class="fas fa-poll me-2"></i>Results
        </button>
    </li>
</ul>

<!-- Tab content -->
<div class="tab-content">
    <!-- Statistics Tab -->
    <div class="tab-pane fade show active" id="statistics" role="tabpanel" aria-labelledby="statistics-tab">
        <div class="row">
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-header">
                        <h3><i class="fas fa-percentage me-2"></i>Percentiles (5th, 50th, 95th)</h3>
                        <p class="mb-0">Key reference values for anthropometric design</p>
                    </div>
                    <div class="card-body">
                        <div class="table-wrapper">
                            {{ percentiles_html|safe }}
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-table me-2"></i>Summary Statistics</h3>
                        <p class="mb-0">Mean, standard deviation, and other statistics for all measurements</p>
                    </div>
                    <div class="card-body">
                        <div class="table-wrapper">
                            {{ summary_html|safe }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PCA Tab -->
    <div class="tab-pane fade" id="pca" role="tabpanel" aria-labelledby="pca-tab">
        <div class="row">
            <div class="col-md-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-info-circle me-2"></i>About PCA</h3>
                    </div>
                    <div class="card-body">
                        <p>
                            Principal Component Analysis (PCA) is a dimensionality reduction technique that identifies the key patterns
                            and relationships in the anthropometric measurements. It transforms the original variables into a new set of
                            orthogonal variables called principal components, which are ordered by the amount of variance they explain.
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-7">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-line me-2"></i>Variance Explained</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="varianceChart" 
                                data-variance="{{ variance_explained }}" 
                                data-cumulative="{{ cumulative_variance }}">
                        </canvas>
                        <div class="mt-3">
                            <p class="mb-0">
                                <strong>Interpretation:</strong> The chart shows how much of the total variation in anthropometric measurements
                                is captured by each principal component. The first few components typically capture most of the important variation.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-5">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-weight me-2"></i>Component Loadings</h3>
                        <p class="text-muted mb-0">Top contributors to each principal component</p>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-pills mb-3" id="loadings-tab" role="tablist">
                            {% for i in range(1, 6) %}
                            <li class="nav-item" role="presentation">
                                <button class="nav-link {% if i == 1 %}active{% endif %}" 
                                        id="pc{{ i }}-tab" 
                                        data-bs-toggle="pill" 
                                        data-bs-target="#pc{{ i }}" 
                                        type="button" role="tab">PC{{ i }}</button>
                            </li>
                            {% endfor %}
                        </ul>
                        
                        <div class="tab-content">
                            {% for i in range(1, 6) %}
                            <div class="tab-pane fade {% if i == 1 %}show active{% endif %}" 
                                 id="pc{{ i }}" 
                                 role="tabpanel">
                                <h5>Principal Component {{ i }}</h5>
                                <p>Explains {{ variance_explained[i-1] }}% of total variance</p>
                                
                                <div class="list-group">
                                    {% for measure, value in top_loadings['PC'+i|string].items() %}
                                    <div class="loading-item">
                                        <span>{{ measure }}</span>
                                        <span class="loading-value {% if value > 0 %}positive{% else %}negative{% endif %}">
                                            {{ "%.3f"|format(value) }}
                                        </span>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <div class="mt-3">
                                    <p class="small">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Positive values indicate measurements that increase together, 
                                        negative values indicate inverse relationships.
                                    </p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Visualizations Tab -->
    <div class="tab-pane fade" id="visualizations" role="tabpanel" aria-labelledby="visualizations-tab">
        <div class="row">
            {% if selected_gender == 'both' %}
            <!-- Gender Comparison Plot (only shown when viewing combined data) -->
            <div class="col-md-12 mb-4">
                <div class="card">
                    <div class="card-header bg-primary bg-opacity-15">
                        <h3><i class="fas fa-venus-mars me-2"></i>Gender Comparison</h3>
                    </div>
                    <div class="card-body text-center">
                        <img src="data:image/png;base64,{{ plots.gender_comparison }}" 
                             class="plot-thumbnail w-75" 
                             alt="Gender Comparison"
                             data-bs-toggle="modal" 
                             data-bs-target="#plotModal" 
                             data-plot-title="Average Measurements by Gender"
                             data-plot-image="data:image/png;base64,{{ plots.gender_comparison }}">
                    </div>
                    <div class="card-footer">
                        <p class="mb-0">
                            <small>
                                Comparison of average measurements between males and females showing the anthropometric differences.
                                Males generally have larger values across most measurements.
                            </small>
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h4><i class="fas fa-box-plot me-2"></i>Key Measurements Distribution</h4>
                    </div>
                    <div class="card-body text-center">
                        <img src="data:image/png;base64,{{ plots.boxplot }}" 
                             class="plot-thumbnail" 
                             alt="Key Measurements Boxplot"
                             data-bs-toggle="modal" 
                             data-bs-target="#plotModal" 
                             data-plot-title="Key Measurements Distribution"
                             data-plot-image="data:image/png;base64,{{ plots.boxplot }}">
                    </div>
                    <div class="card-footer">
                        <p class="mb-0">
                            <small>
                                {% if selected_gender == 'both' %}
                                    Boxplots showing the distribution of key anthropometric measurements by gender,
                                    with males (blue) and females (pink).
                                {% else %}
                                    Boxplots showing the distribution of key anthropometric measurements for 
                                    {{ selected_gender }} subjects, including median and quartiles.
                                {% endif %}
                            </small>
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h4><i class="fas fa-chart-line me-2"></i>PCA Scree Plot</h4>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h4><i class="fas fa-users me-2"></i>Male Clustering Analysis</h4>
                    </div>
                    <div class="card-body">
                        <img src="data:image/png;base64,{{ plots.cluster_male }}" class="img-fluid" alt="Male Clustering">
                    </div>
                </div>
            </div>
            
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h4><i class="fas fa-users me-2"></i>Female Clustering Analysis</h4>
                    </div>
                    <div class="card-body">
                        <img src="data:image/png;base64,{{ plots.cluster_female }}" class="img-fluid" alt="Female Clustering">
                    </div>
                </div>
            </div>
            
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h4><i class="fas fa-chart-line me-2"></i>PCA Scree Plot</h4>
                    </div>
                    <div class="card-body text-center">
                        <img src="data:image/png;base64,{{ plots.scree_plot }}" 
                             class="plot-thumbnail" 
                             alt="PCA Scree Plot"
                             data-bs-toggle="modal" 
                             data-bs-target="#plotModal" 
                             data-plot-title="PCA Scree Plot"
                             data-plot-image="data:image/png;base64,{{ plots.scree_plot }}">
                    </div>
                    <div class="card-footer">
                        <p class="mb-0">
                            <small>
                                Scree plot showing variance explained by each principal component
                                and cumulative variance.
                            </small>
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h4><i class="fas fa-project-diagram me-2"></i>PCA Scatter Plot</h4>
                    </div>
                    <div class="card-body text-center">
                        <img src="data:image/png;base64,{{ plots.pca_scatter }}" 
                             class="plot-thumbnail" 
                             alt="PCA Scatter Plot"
                             data-bs-toggle="modal" 
                             data-bs-target="#plotModal" 
                             data-plot-title="PCA Scatter Plot"
                             data-plot-image="data:image/png;base64,{{ plots.pca_scatter }}">
                    </div>
                    <div class="card-footer">
                        <p class="mb-0">
                            <small>
                                Scatter plot of the first two principal components showing
                                the distribution of samples in the reduced dimension space.
                            </small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        </div>
    
    <!-- Results Tab -->
    <div class="tab-pane fade" id="results" role="tabpanel" aria-labelledby="results-tab">
        <div class="row">
            <div class="col-md-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-poll me-2"></i>Analysis Results</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h4>Cluster Analysis</h4>
                                    </div>
                                    <div class="card-body">
                                        <img src="data:image/png;base64,{{ plots.cluster_male }}" class="img-fluid mb-3" alt="Male Clustering">
                                        <img src="data:image/png;base64,{{ plots.cluster_female }}" class="img-fluid" alt="Female Clustering">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h4>Statistical Summary</h4>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            {{ summary_html|safe }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Download section -->
        <div class="download-section text-center">
            <h3 class="mb-3">Want more detailed analysis?</h3>
            <p class="mb-4">Download the complete Excel report with all measurements, statistics, and PCA results</p>
            <a href="/download" class="btn btn-primary btn-lg" id="download-btn-alt">
                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                <span class="btn-text">Download Excel Report</span>
                <i class="fas fa-file-excel ms-2"></i>
            </a>
        </div>
    </div>
</div>

<!-- Modal for enlarged plots -->
<div class="modal fade" id="plotModal" tabindex="-1" aria-labelledby="plotModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="plotModalLabel">Plot</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="modal-image" alt="Enlarged plot">
            </div>
        </div>
    </div>
</div>

<script>
    // Modal image handler
    document.querySelectorAll('.plot-thumbnail').forEach(img => {
        img.addEventListener('click', function() {
            document.getElementById('plotModalLabel').textContent = this.getAttribute('data-plot-title');
            document.getElementById('modalImage').src = this.getAttribute('data-plot-image');
        });
    });
</script>
{% endblock %}
